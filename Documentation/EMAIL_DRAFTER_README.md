# Email Drafter Agent

A Python agent that creates Gmail draft messages from feedback messages generated by the Message Writer Agent.

## Features

- Reads feedback messages from Excel files
- Creates Gmail draft messages using Gmail API
- Automatic subject line generation: "Feedback message to [ID]"
- OAuth 2.0 authentication with Gmail API
- Batch processing of multiple feedback messages
- Progress tracking and error handling
- Integrates seamlessly with the complete pipeline

## Requirements

- Python 3.7 or higher
- Gmail API enabled in Google Cloud Console
- OAuth 2.0 credentials with Gmail compose scope
- openpyxl package (already in requirements.txt)
- google-api-python-client package (already in requirements.txt)

## Important: Separate Authentication Token

The Email Drafter uses a **separate authentication token** (`token_drafter.pickle`) from the Gmail Agent (`token.pickle`) because it requires different permissions:

- **Gmail Agent**: Uses `gmail.readonly` scope (read emails only)
- **Email Drafter**: Uses `gmail.compose` scope (create drafts)

**First Run**: When you run the email drafter for the first time, it will ask you to authenticate again, even if you've already authenticated for the Gmail Agent. This is normal and necessary to grant draft creation permissions.

## Usage

### Basic Usage

```bash
python email_drafter.py --input Output_34.xlsx
```

This will:
1. Read feedback messages from `Output_34.xlsx`
2. Authenticate with Gmail API
3. Create a draft message for each feedback entry
4. Store drafts in your Gmail Drafts folder

### Command-Line Options

- `--input`: Input Excel file with feedback messages (default: `Output_34.xlsx`)
- `--credentials`: Path to OAuth credentials file (default: `credentials.json`)

### Examples

#### Use custom input file

```bash
python email_drafter.py --input student_feedback.xlsx
```

#### Use custom credentials

```bash
python email_drafter.py --input feedback.xlsx --credentials my_creds.json
```

## Input File Format

The input Excel file must contain these columns:

- **ID** - Unique identifier (used in subject line)
- **Feedback Message** - The message content to send as draft

Optional columns (for future enhancements):
- **Subject** - Can be used as subject prefix
- **Email** or **Recipient** - Recipient email address

## Output

The agent creates Gmail draft messages in your account's Drafts folder:

- **Subject**: "Feedback message to [ID]"
- **Body**: The complete feedback message from Excel
- **Status**: Draft (not sent automatically)

## How It Works

### 1. Authentication

Authenticates with Gmail API using OAuth 2.0:

```python
SCOPES = ['https://www.googleapis.com/auth/gmail.compose']
```

- First run: Opens browser for Google authentication
- Subsequent runs: Uses saved `token.pickle` file
- WSL/headless support: Automatic fallback to console authentication

### 2. Read Feedback Data

Loads Excel file and extracts:
- Repository/submission IDs
- Feedback messages
- Optional metadata

```python
drafter = EmailDrafter(input_file='Output_34.xlsx')
data = drafter.read_excel_data()
```

### 3. Create Drafts

For each feedback message:
- Generates subject: "Feedback message to [ID]"
- Creates MIME message with feedback as body
- Encodes message in base64
- Creates draft via Gmail API

```python
draft = service.users().drafts().create(userId='me', body=draft_body).execute()
```

### 4. Summary Report

Displays statistics:

```
Draft Creation Summary
======================================================================
Total Feedback Messages: 15
Drafts Created: 14
Failed: 1

✓ Drafts are available in your Gmail account under 'Drafts' folder
```

## Example Output

### Console Output

```
✓ Successfully authenticated with Gmail API

Reading data from Output_34.xlsx...
Found 10 feedback messages to draft

======================================================================
Creating Gmail Draft Messages
======================================================================

[1/10] Creating draft for ID: 12345
  ✓ Draft created successfully (ID: r-1234567890)
[2/10] Creating draft for ID: 12346
  ✓ Draft created successfully (ID: r-1234567891)
[3/10] Creating draft for ID: 12347
  ✓ Draft created successfully (ID: r-1234567892)
...

======================================================================
Draft Creation Summary
======================================================================
Total Feedback Messages: 10
Drafts Created: 10
Failed: 0

✓ Drafts are available in your Gmail account under 'Drafts' folder
```

### Gmail Drafts Folder

After running, your Gmail Drafts folder will contain:

```
Subject: Feedback message to 12345
Body: INCREDIBLE! Absolutely INCREDIBLE! This code is 95.3% modular...

Subject: Feedback message to 12346
Body: Let me be clear: achieving 78.5% modularity demonstrates...

Subject: Feedback message to 12347
Body: אז... 62.7% modularity. לא רע, לא רע בכלל!...
```

## Integration with Pipeline

The email drafter integrates seamlessly with the complete pipeline:

```json
{
  "searches": [ /* email searches */ ],
  "analyze_repos": { /* repo analysis */ },
  "generate_messages": { /* message generation */ },
  "draft_emails": {
    "input_file": "Output_34.xlsx",
    "credentials_file": "credentials.json"
  }
}
```

Full pipeline execution:
1. Gmail Agent retrieves emails → `Output_12.xlsx`
2. Analyze Repos clones and analyzes → `Output_23.xlsx`
3. Message Writer generates feedback → `Output_34.xlsx`
4. Email Drafter creates Gmail drafts

## Use Cases

### Student Assignment Feedback

```bash
# Generate feedback and create drafts for students
python pipeline.py --config student_config.json
```

Pipeline automatically:
- Retrieves student submission emails
- Analyzes repository code quality
- Generates personalized feedback (Trump/Netanyahu/Hason/Amsalem styles)
- Creates draft emails ready to review and send

### Code Review Automation

```bash
# Create draft feedback for code reviews
python email_drafter.py --input team_analysis.xlsx
```

- Automated draft generation for team code reviews
- Consistent feedback format
- Ready to customize before sending

### Teaching Assistant Workflow

1. Students submit repositories via email
2. Pipeline analyzes all submissions
3. Generates grade-based feedback messages
4. Creates drafts for each student
5. TA reviews and sends drafts

## Authentication

### First Time Setup

When you run the agent for the first time:

1. **Browser Authentication** (Default):
   - Opens browser automatically
   - Redirects to Google login
   - Asks for permissions to compose emails
   - Saves token as `token.pickle`

2. **Console Authentication** (WSL/Headless):
   - Displays URL in console
   - Copy/paste URL to browser
   - Complete authentication
   - Copy/paste code back to console
   - Saves token as `token.pickle`

### Gmail API Scopes

The agent requests minimal permissions:

```python
SCOPES = ['https://www.googleapis.com/auth/gmail.compose']
```

This scope allows:
- Creating draft messages
- Managing drafts (edit/delete)

This scope does NOT allow:
- Sending emails directly
- Reading existing emails
- Modifying sent messages

## Security Notes

- **Drafts Only**: Agent creates drafts, never sends automatically
- **Review Before Sending**: Always review drafts before sending
- **Minimal Permissions**: Only requests compose scope
- **Secure Credentials**: Keep `credentials.json` and `token.pickle` secure
- **Never commit**: Add credentials to `.gitignore`

## Troubleshooting

### "Credentials file not found"

Make sure `credentials.json` exists in the project directory. Download from Google Cloud Console.

### "Access blocked: This app's request is invalid"

1. Go to Google Cloud Console > APIs & Services > OAuth consent screen
2. Add your email as a test user
3. Ensure Gmail API is enabled

### "Token has been expired or revoked"

Delete `token_drafter.pickle` and re-authenticate:

```bash
rm token_drafter.pickle
python email_drafter.py --input Output_34.xlsx
```

### "No feedback messages found"

Ensure input file:
- Has "ID" column
- Has "Feedback Message" column
- Contains non-empty feedback messages

### "Insufficient permissions" or "HttpError 403"

The agent requires the `gmail.compose` scope. This error usually means:

1. **You're using the wrong token file**: Make sure you're not using `token.pickle` (which has readonly scope). The email drafter automatically uses `token_drafter.pickle`.

2. **First time running**: If this is your first time running the email drafter, delete any old tokens and authenticate fresh:

```bash
rm token_drafter.pickle
python email_drafter.py --input Output_34.xlsx
```

3. **Gmail API not enabled**: Ensure Gmail API is enabled in your Google Cloud Console project.

4. **Scope not added to OAuth consent screen**: Make sure your OAuth consent screen includes the compose scope.

### Rate Limits

Gmail API has usage quotas:
- 25,000 quota units per day (per project)
- Creating a draft uses 100 quota units
- This allows ~250 drafts per day

For higher limits, request quota increase in Google Cloud Console.

## Customization

### Change Subject Format

Edit `create_draft()` method in `email_drafter.py`:

```python
# Default
subject = f"Feedback message to {repo_id}"

# Custom
subject = f"Code Review Feedback - Repository {repo_id}"
```

### Add Recipient Email

Currently drafts are created without recipients. To add recipients, modify:

```python
message = MIMEText(feedback_message)
message['subject'] = subject
message['to'] = recipient_email  # Add this line
```

Then update Excel reading to extract recipient emails.

### Add Email Template

Wrap feedback in a professional template:

```python
email_body = f"""
Hello,

Thank you for your submission. Here is the feedback for your repository:

{feedback_message}

Best regards,
Course Staff
"""

message = MIMEText(email_body)
```

## Advanced Usage

### Standalone Operation

Run independently from pipeline:

```bash
python email_drafter.py --input any_file_with_feedback.xlsx
```

### Batch Processing

Process multiple feedback files:

```bash
for file in feedback_*.xlsx; do
    python email_drafter.py --input "$file"
done
```

### Integration with Other Systems

The agent can be imported and used in other Python scripts:

```python
from email_drafter import EmailDrafter

drafter = EmailDrafter(
    input_file='custom_feedback.xlsx',
    credentials_file='credentials.json'
)

results = drafter.run()
print(f"Created {results['success']} drafts")
```

## Performance

- **Fast**: Creates 10-20 drafts per second
- **Efficient**: Batch processing with error handling
- **Reliable**: Automatic retry on transient failures
- **Scalable**: Handles hundreds of drafts easily

## Limitations

- Requires Gmail account (not other email providers)
- Requires OAuth 2.0 credentials from Google Cloud
- Does not send emails automatically (drafts only)
- Subject line format is fixed (customizable via code)
- No email templates (plain text only, customizable via code)
- Daily API quota limits apply

## Future Enhancements

Potential improvements:
- HTML email templates with styling
- Recipient email extraction from Excel
- CC/BCC support
- Attachment support
- Email scheduling
- Send confirmation workflow
- Multiple email templates based on grade

## Best Practices

1. **Review Drafts**: Always review before sending
2. **Test First**: Test with small batch before processing all
3. **Backup Data**: Keep Excel files as records
4. **Monitor Quota**: Check API usage in Google Cloud Console
5. **Secure Credentials**: Never share or commit credentials
6. **Customize Messages**: Edit drafts as needed before sending

## License

This project is open source and available for personal and educational use.

## Support

For issues related to:
- **Gmail API**: Check [Gmail API documentation](https://developers.google.com/gmail/api)
- **OAuth 2.0**: Check [OAuth 2.0 documentation](https://developers.google.com/identity/protocols/oauth2)
- **Google Cloud setup**: Check [Google Cloud documentation](https://cloud.google.com/docs)
